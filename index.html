<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFEN局面ビューア</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
             background-color: #111827;
        }
        .shogi-board {
            border-collapse: collapse;
            border: 2px solid #7d5a3a;
            background-color: #f3e5ca;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .shogi-board td {
            width: 36px;
            height: 40px;
            border: 1px solid #b4936c;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            cursor: default;
            user-select: none;
        }
        .shogi-board td.promoted {
            color: #c0392b;
        }
        .shogi-board td.gote {
            transform: rotate(180deg);
        }
        .hand-area {
            min-height: 40px;
            padding: 8px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.05);
        }
        .dark .hand-area {
            background-color: rgba(255,255,255,0.08);
        }
        .piece-in-hand {
            display: inline-flex;
            align-items: center;
            margin: 2px;
            font-size: 18px;
        }
    </style>
</head>
<body class="dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">SFEN局面ビューア</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">CSVファイルをアップロードして、SFEN局面を将棋盤で一覧表示します。</p>
        </header>

        <div class="max-w-xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 mb-8">
             <label for="csv-file" class="block mb-2 text-lg font-medium text-gray-700 dark:text-gray-300">CSVファイルを選択</label>
             <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900/50 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-900"/>
        </div>

        <div id="status-display" class="hidden my-4 max-w-xl mx-auto p-4 text-center bg-blue-100 dark:bg-blue-900 border border-blue-400 dark:border-blue-700 text-blue-700 dark:text-blue-200 rounded-lg">
            <p id="status-message"></p>
        </div>
        
        <div id="boards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- ここに将棋盤がレンダリングされます -->
        </div>

    </div>

    <script>
        const sfenToKanjiMap = {
            'P': '歩', 'L': '香', 'N': '桂', 'S': '銀', 'G': '金', 'B': '角', 'R': '飛', 'K': '玉',
            '+P': 'と', '+L': '杏', '+N': '圭', '+S': '全', '+B': '馬', '+R': '龍'
        };

        const fileInput = document.getElementById('csv-file');
        const boardsContainer = document.getElementById('boards-container');
        const statusDisplay = document.getElementById('status-display');
        const statusMessage = document.getElementById('status-message');

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            boardsContainer.innerHTML = '';
            showStatus('CSVファイルを処理中...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const records = parseCSV(csvText);
                    if (records.length === 0) {
                        showStatus('CSVファイルから有効なSFEN局面を読み込めませんでした。ヘッダーが "SFEN,出現回数" になっているか確認してください。', true);
                        return;
                    }
                    displayBoards(records);
                    hideStatus();
                } catch (error) {
                    showStatus(`エラー: ${error.message}`, true);
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            const header = lines.shift().split(',');
            
            // ヘッダーからSFENと出現回数のインデックスを見つける
            const sfenIndex = header.findIndex(h => h.toLowerCase().includes('sfen'));
            const countIndex = header.findIndex(h => h.toLowerCase().includes('出現回数'));
            
            if (sfenIndex === -1 || countIndex === -1) {
                throw new Error('CSVヘッダーに "SFEN" と "出現回数" が見つかりません。');
            }

            return lines.map(line => {
                // 正規表現でSFENとそれ以降を分離
                const match = line.match(/"(.*?)"\s*,(.*)/);
                if (match) {
                    return {
                        sfen: match[1],
                        count: parseInt(match[2], 10)
                    };
                }
                // シンプルなカンマ区切りにも対応
                const values = line.split(',');
                return {
                    sfen: values[sfenIndex].replace(/"/g, ''),
                    count: parseInt(values[countIndex], 10)
                };
            }).filter(r => r.sfen && !isNaN(r.count));
        }

        function displayBoards(records) {
            records.forEach(record => {
                const boardElement = createBoardElement(record.sfen, record.count);
                boardsContainer.appendChild(boardElement);
            });
        }
        
        function createBoardElement(sfen, count) {
            const [boardState, turn, hands, moveNum] = sfen.split(' ');

            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center';

            // 持ち駒(後手)
            const goteHandDiv = document.createElement('div');
            goteHandDiv.className = 'hand-area w-full mb-2';
            const goteHand = parseHand(hands, 'gote');
            goteHandDiv.innerHTML = `<div>後手持: ${goteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? p.count : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(goteHandDiv);
            
            // 将棋盤
            wrapper.appendChild(createBoardTable(boardState));

            // 持ち駒(先手)
            const senteHandDiv = document.createElement('div');
            senteHandDiv.className = 'hand-area w-full mt-2';
            const senteHand = parseHand(hands, 'sente');
            senteHandDiv.innerHTML = `<div>先手持: ${senteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? p.count : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(senteHandDiv);

            // 情報
            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-center mt-3 w-full';
            infoDiv.innerHTML = `
                <p class="text-sm text-gray-600 dark:text-gray-400">出現回数: <span class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${count}</span></p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1 break-all">${sfen}</p>
            `;
            wrapper.appendChild(infoDiv);

            return wrapper;
        }
        
        function createBoardTable(boardState) {
            const table = document.createElement('table');
            table.className = 'shogi-board';
            const rows = boardState.split('/');

            for (let y = 0; y < 9; y++) {
                const tr = table.insertRow();
                let x = 0;
                let isPromotedFlag = false;
                for (const char of rows[y]) {
                    if (char === '+') {
                        isPromotedFlag = true;
                        continue;
                    }
                    if (!isNaN(parseInt(char))) {
                        for (let i = 0; i < parseInt(char); i++) {
                            tr.insertCell();
                            x++;
                        }
                    } else {
                        const td = tr.insertCell();
                        const isGote = char === char.toLowerCase();
                        const pieceKey = (isPromotedFlag ? '+' : '') + char.toUpperCase();
                        
                        td.textContent = sfenToKanjiMap[pieceKey] || '?';
                        if (isGote) td.classList.add('gote');
                        if (isPromotedFlag) td.classList.add('promoted');
                        
                        isPromotedFlag = false;
                        x++;
                    }
                }
            }
            return table;
        }

        function parseHand(handsStr, player) {
            if (!handsStr || handsStr === '-') return [];
            
            const hand = [];
            let count = 1;

            for (const char of handsStr) {
                if (!isNaN(parseInt(char))) {
                    count = parseInt(char);
                } else {
                    const isSente = char === char.toUpperCase();
                    if ((player === 'sente' && isSente) || (player === 'gote' && !isSente)) {
                       hand.push({
                           kanji: sfenToKanjiMap[char.toUpperCase()] || '?',
                           count: count
                       });
                    }
                    count = 1;
                }
            }
            return hand;
        }
        
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusDisplay.classList.remove('hidden');
            statusDisplay.classList.toggle('bg-red-100', isError);
            statusDisplay.classList.toggle('dark:bg-red-900', isError);
            statusDisplay.classList.toggle('border-red-400', isError);
            statusDisplay.classList.toggle('dark:border-red-700', isError);
            statusDisplay.classList.toggle('text-red-700', isError);
            statusDisplay.classList.toggle('dark:text-red-200', isError);
        }

        function hideStatus() {
            statusDisplay.classList.add('hidden');
        }

    </script>
</body>
</html>
