<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFEN局面ビューア</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
             background-color: #111827;
        }
        .shogi-board {
            border-collapse: collapse;
            border: 2px solid #7d5a3a;
            background-color: #f3e5ca;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .shogi-board td {
            width: 36px;
            height: 40px;
            border: 1px solid #b4936c;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            cursor: default;
            user-select: none;
        }
        .shogi-board td.promoted {
            color: #c0392b;
        }
        .shogi-board td.gote {
            transform: rotate(180deg);
        }
        .hand-area {
            min-height: 40px;
            padding: 8px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.05);
        }
        .dark .hand-area {
            background-color: rgba(255,255,255,0.08);
        }
        .piece-in-hand {
            display: inline-flex;
            align-items: center;
            margin: 2px;
            font-size: 18px;
        }
        .sfen-input {
             cursor: default;
        }
    </style>
</head>
<body class="dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">SFEN局面ビューア</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">CSVファイルをアップロードして、SFEN局面を将棋盤で一覧表示します。</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 mb-8">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="csv-file" class="block mb-2 text-lg font-medium text-gray-700 dark:text-gray-300">1. CSVファイルを選択</label>
                    <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900/50 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-900"/>
                </div>
                 <div>
                    <h3 class="block mb-2 text-lg font-medium text-gray-700 dark:text-gray-300">2. 表示オプション</h3>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label for="min-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300">出現回数の下限</label>
                            <input type="number" id="min-count" value="1" min="1" class="w-24 mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="column-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300">横の表示数 (列)</label>
                            <input type="number" id="column-count" value="3" min="1" max="6" class="w-24 mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                 </div>
             </div>
             <div class="mt-6 text-center">
                <button id="apply-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>表示を更新</button>
             </div>
        </div>

        <div id="status-display" class="my-4 max-w-xl mx-auto p-4 text-center bg-blue-100 dark:bg-blue-900 border border-blue-400 dark:border-blue-700 text-blue-700 dark:text-blue-200 rounded-lg">
            <p id="status-message">CSVファイルをアップロードしてください。</p>
        </div>
        
        <div id="boards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- ここに将棋盤がレンダリングされます -->
        </div>

    </div>

    <script>
        const sfenToKanjiMap = {
            'P': '歩', 'L': '香', 'N': '桂', 'S': '銀', 'G': '金', 'B': '角', 'R': '飛', 'K': '玉',
            '+P': 'と', '+L': '杏', '+N': '圭', '+S': '全', '+B': '馬', '+R': '龍'
        };
        
        // DOM Elements
        const fileInput = document.getElementById('csv-file');
        const boardsContainer = document.getElementById('boards-container');
        const statusDisplay = document.getElementById('status-display');
        const statusMessage = document.getElementById('status-message');
        const minCountInput = document.getElementById('min-count');
        const columnCountInput = document.getElementById('column-count');
        const applySettingsButton = document.getElementById('apply-settings');
        
        let allRecords = [];

        // Event Listeners
        fileInput.addEventListener('change', handleFileSelect);
        applySettingsButton.addEventListener('click', renderFilteredBoards);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showStatus('CSVファイルを処理中...');
            applySettingsButton.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    allRecords = parseCSV(csvText);
                    if (allRecords.length === 0) {
                        showStatus('CSVファイルから有効なSFEN局面を読み込めませんでした。ヘッダーが "SFEN" で始まっているか確認してください。', true);
                        return;
                    }
                    applySettingsButton.disabled = false;
                    renderFilteredBoards();
                } catch (error) {
                    showStatus(`エラー: ${error.message}`, true);
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function renderFilteredBoards() {
            if (allRecords.length === 0) {
                showStatus('表示するデータがありません。まずCSVファイルをアップロードしてください。', true);
                return;
            }

            boardsContainer.innerHTML = '';
            const minCount = parseInt(minCountInput.value, 10) || 1;
            const columnCount = parseInt(columnCountInput.value, 10) || 3;
            
            const filteredRecords = allRecords.filter(record => record.count >= minCount);

            if (filteredRecords.length === 0) {
                showStatus('指定された条件に一致する局面はありません。');
                return;
            }

            // Update grid columns class
            boardsContainer.className = `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${columnCount} gap-8`;
            
            displayBoards(filteredRecords);
            showStatus(`${filteredRecords.length} 件の局面を表示しています。`);
        }


        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            const headerLine = lines.shift();
            
            if (!headerLine.toLowerCase().startsWith('sfen')) {
                 throw new Error('CSVヘッダーの最初の列が "SFEN" ではありません。');
            }
            const header = headerLine.split(',');
            const countIndex = header.findIndex(h => h.toLowerCase().includes('出現回数'));
            if(countIndex === -1) {
                throw new Error('CSVヘッダーに "出現回数" が見つかりません。');
            }

            return lines.map(line => {
                const match = line.match(/"(.*?)"\s*,(.*)/);
                if (match) {
                    return {
                        sfen: match[1],
                        count: parseInt(match[2], 10)
                    };
                }
                const values = line.split(',');
                return {
                    sfen: values[0].replace(/"/g, ''),
                    count: parseInt(values[countIndex], 10)
                };
            }).filter(r => r.sfen && !isNaN(r.count));
        }

        function displayBoards(records) {
            records.forEach(record => {
                const boardElement = createBoardElement(record.sfen, record.count);
                boardsContainer.appendChild(boardElement);
            });
        }
        
        function createBoardElement(sfen, count) {
            const [boardState, turn, hands, moveNum] = sfen.split(' ');
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center';

            const goteHandDiv = document.createElement('div');
            goteHandDiv.className = 'hand-area w-full mb-2';
            const goteHand = parseHand(hands, 'gote');
            goteHandDiv.innerHTML = `<div class="text-sm">後手持: ${goteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? p.count : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(goteHandDiv);
            
            wrapper.appendChild(createBoardTable(boardState));

            const senteHandDiv = document.createElement('div');
            senteHandDiv.className = 'hand-area w-full mt-2';
            const senteHand = parseHand(hands, 'sente');
            senteHandDiv.innerHTML = `<div class="text-sm">先手持: ${senteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? p.count : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(senteHandDiv);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'w-full mt-4 space-y-3';
            
            let countHTML = '';
            if (count !== null && !isNaN(count)) {
                countHTML = `
                <div class="text-center">
                    <span class="text-sm text-gray-500 dark:text-gray-400">出現回数</span>
                    <p class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${count}</p>
                </div>`;
            }

            infoDiv.innerHTML = `
                <div class="flex justify-around items-baseline">
                    <div class="text-center">
                        <span class="text-sm text-gray-500 dark:text-gray-400">手番</span>
                        <p class="font-bold text-lg">${turn === 'b' ? '▲ 先手' : '△ 後手'}</p>
                    </div>
                    ${countHTML}
                </div>
            `;

            const sfenContainer = document.createElement('div');
            sfenContainer.className = 'relative flex items-center';

            const sfenInput = document.createElement('input');
            sfenInput.type = 'text';
            sfenInput.value = sfen;
            sfenInput.readOnly = true;
            sfenInput.className = 'sfen-input text-xs w-full text-gray-500 bg-gray-100 dark:bg-gray-700 p-2 pr-10 rounded-md border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500';

            const copyButton = document.createElement('button');
            copyButton.title = "SFENをコピー";
            copyButton.className = 'absolute right-0 top-0 h-full px-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white transition-colors';
            const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
            const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
            copyButton.innerHTML = copyIcon;

            copyButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sfenInput.select();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                
                copyButton.innerHTML = successIcon;
                setTimeout(() => {
                    copyButton.innerHTML = copyIcon;
                }, 2000);
            });
            
            sfenContainer.appendChild(sfenInput);
            sfenContainer.appendChild(copyButton);
            infoDiv.appendChild(sfenContainer);
            wrapper.appendChild(infoDiv);

            return wrapper;
        }
        
        function createBoardTable(boardState) {
            const table = document.createElement('table');
            table.className = 'shogi-board';
            const rows = boardState.split('/');

            for (let y = 0; y < 9; y++) {
                const tr = table.insertRow();
                let x = 0;
                let isPromotedFlag = false;
                for (const char of rows[y]) {
                    if (char === '+') {
                        isPromotedFlag = true;
                        continue;
                    }
                    if (!isNaN(parseInt(char))) {
                        for (let i = 0; i < parseInt(char); i++) {
                            tr.insertCell();
                            x++;
                        }
                    } else {
                        const td = tr.insertCell();
                        const isGote = char === char.toLowerCase();
                        const pieceKey = (isPromotedFlag ? '+' : '') + char.toUpperCase();
                        
                        td.textContent = sfenToKanjiMap[pieceKey] || '?';
                        if (isGote) td.classList.add('gote');
                        if (isPromotedFlag) td.classList.add('promoted');
                        
                        isPromotedFlag = false;
                        x++;
                    }
                }
            }
            return table;
        }

        function parseHand(handsStr, player) {
            if (!handsStr || handsStr === '-') return [];
            
            const hand = [];
            let count = 1;

            for (const char of handsStr) {
                if (!isNaN(parseInt(char))) {
                    count = parseInt(char);
                } else {
                    const isSente = char === char.toUpperCase();
                    if ((player === 'sente' && isSente) || (player === 'gote' && !isSente)) {
                       hand.push({
                           kanji: sfenToKanjiMap[char.toUpperCase()] || '?',
                           count: count
                       });
                    }
                    count = 1;
                }
            }
            return hand;
        }
        
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusDisplay.classList.remove('hidden');
            statusDisplay.classList.toggle('bg-red-100', isError);
            statusDisplay.classList.toggle('dark:bg-red-900', isError);
            statusDisplay.classList.toggle('border-red-400', isError);
            statusDisplay.classList.toggle('dark:border-red-700', isError);
            statusDisplay.classList.toggle('text-red-700', isError);
            statusDisplay.classList.toggle('dark:text-red-200', isError);
        }

        function hideStatus() {
            statusDisplay.classList.add('hidden');
        }

    </script>
</body>
</html>
