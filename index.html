<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFEN局面ビューア</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
             background-color: #111827;
        }
        .shogi-board {
            border-collapse: collapse;
            border: 2px solid #7d5a3a;
            background-color: #f3e5ca;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .shogi-board td {
            width: 32px;
            height: 36px;
            border: 1px solid #b4936c;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: default;
            user-select: none;
        }
        .shogi-board td.promoted {
            color: #c0392b;
        }
        .shogi-board td.gote {
            transform: rotate(180deg);
        }
        .hand-area {
            min-height: 36px;
            padding: 6px;
            border-radius: 6px;
            background-color: rgba(0,0,0,0.05);
        }
        .dark .hand-area {
            background-color: rgba(255,255,255,0.08);
        }
        .piece-in-hand {
            display: inline-flex;
            align-items: center;
            margin: 1px 2px;
            font-size: 16px;
        }
        .sfen-input {
             cursor: default;
        }
    </style>
</head>
<body class="dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">SFEN局面ビューア</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">CSVファイルをアップロード、または保存済みデータから選択して局面を一覧表示します。</p>
        </header>

        <div class="grid lg:grid-cols-4 gap-8">
            <!-- Left Column: Inputs and Saved Data -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <label for="csv-file" class="block mb-2 text-lg font-medium text-gray-700 dark:text-gray-300">CSVファイルを選択</label>
                    <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900/50 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-900"/>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">保存済みデータ</h3>
                    <div id="storage-status" class="text-xs text-gray-500 dark:text-gray-400 my-2"></div>
                    
                    <div class="mt-4 space-y-2">
                         <label for="storage-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ストレージ上限 (MB)</label>
                         <div class="flex items-center gap-2">
                             <input type="number" id="storage-limit" value="1" min="1" max="5" class="w-20 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                             <button id="save-storage-limit" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-2 rounded">設定を保存</button>
                         </div>
                    </div>

                    <ul id="saved-files-list" class="space-y-3 mt-4 max-h-80 overflow-y-auto pr-2">
                        <!-- Saved items will be injected here -->
                    </ul>
                </div>
            </div>

            <!-- Right Column: Viewer and Options -->
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="block mb-4 text-lg font-medium text-gray-700 dark:text-gray-300">表示オプション</h3>
                     <div class="flex flex-wrap items-center gap-6">
                        <div>
                            <label for="min-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300">出現回数の下限</label>
                            <input type="number" id="min-count" value="1" min="1" class="w-24 mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="min-move" class="block text-sm font-medium text-gray-700 dark:text-gray-300">開始手数</label>
                            <input type="number" id="min-move" value="1" min="1" class="w-24 mt-1 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="self-end">
                            <button id="apply-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">表示を更新</button>
                        </div>
                     </div>
                </div>

                <div id="status-display" class="my-4 p-4 text-center bg-blue-100 dark:bg-blue-900/50 border border-blue-400 dark:border-blue-700 text-blue-700 dark:text-blue-200 rounded-lg">
                    <p id="status-message">CSVファイルをアップロードするか、保存済みデータから選択してください。</p>
                </div>
                
                <div id="boards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Boards will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const sfenToKanjiMap = { 'P': '歩', 'L': '香', 'N': '桂', 'S': '銀', 'G': '金', 'B': '角', 'R': '飛', 'K': '玉', '+P': 'と', '+L': '杏', '+N': '圭', '+S': '全', '+B': '馬', '+R': '龍' };
        const STORAGE_PREFIX = 'sfen_viewer_csv_';
        const STORAGE_LIMIT_KEY = 'sfen_viewer_storage_limit_mb';

        // DOM Elements
        const fileInput = document.getElementById('csv-file');
        const boardsContainer = document.getElementById('boards-container');
        const statusDisplay = document.getElementById('status-display');
        const statusMessage = document.getElementById('status-message');
        const minCountInput = document.getElementById('min-count');
        const minMoveInput = document.getElementById('min-move');
        const applySettingsButton = document.getElementById('apply-settings');
        const savedFilesList = document.getElementById('saved-files-list');
        const storageStatusDiv = document.getElementById('storage-status');
        const storageLimitInput = document.getElementById('storage-limit');
        const saveStorageLimitButton = document.getElementById('save-storage-limit');
        
        let allRecords = [];

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        fileInput.addEventListener('change', handleFileSelect);
        applySettingsButton.addEventListener('click', renderFilteredBoards);
        saveStorageLimitButton.addEventListener('click', saveStorageLimit);

        // --- Initialization ---
        function initializeApp() {
            const savedLimit = localStorage.getItem(STORAGE_LIMIT_KEY);
            if(savedLimit) {
                storageLimitInput.value = savedLimit;
            }
            loadSavedFiles();
        }

        // --- Core Functions ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showStatus('CSVファイルを処理中...');
            applySettingsButton.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                processAndRender(csvText);
                saveCsvToLocalStorage(file.name, csvText);
            };
            reader.readAsText(file);
        }

        function processAndRender(csvText) {
            try {
                allRecords = parseCSV(csvText);
                if (allRecords.length === 0) {
                    showStatus('CSVファイルから有効なSFEN局面を読み込めませんでした。ヘッダーを確認してください。', true);
                    return;
                }
                applySettingsButton.disabled = false;
                renderFilteredBoards();
            } catch (error) {
                showStatus(`エラー: ${error.message}`, true);
                console.error(error);
            }
        }

        function renderFilteredBoards() {
            if (allRecords.length === 0) {
                showStatus('表示するデータがありません。', true);
                return;
            }

            boardsContainer.innerHTML = '';
            const minCount = parseInt(minCountInput.value, 10) || 1;
            const minMove = parseInt(minMoveInput.value, 10) || 1;
            
            const filteredRecords = allRecords.filter(record => {
                 const moveNumber = parseInt(record.sfen.split(' ')[3], 10);
                 return record.count >= minCount && moveNumber >= minMove;
            });

            if (filteredRecords.length === 0) {
                showStatus('指定された条件に一致する局面はありません。');
                return;
            }
            
            displayBoards(filteredRecords);
            showStatus(`${filteredRecords.length} 件の局面を表示しています。`);
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            const headerLine = lines.shift();
            if (!headerLine || !headerLine.toLowerCase().startsWith('sfen')) {
                 throw new Error('CSVヘッダーの最初の列が "SFEN" ではありません。');
            }
            const header = headerLine.split(',');
            const countIndex = header.findIndex(h => h.toLowerCase().includes('出現回数'));
            if(countIndex === -1) { throw new Error('CSVヘッダーに "出現回数" が見つかりません。'); }

            return lines.map(line => {
                const match = line.match(/"(.*?)"\s*,(.*)/);
                if (match) return { sfen: match[1], count: parseInt(match[2], 10) };
                const values = line.split(',');
                return { sfen: values[0].replace(/"/g, ''), count: parseInt(values[countIndex], 10) };
            }).filter(r => r.sfen && !isNaN(r.count));
        }

        // --- LocalStorage Functions ---
        function saveStorageLimit() {
            let limit = parseInt(storageLimitInput.value, 10);
            if (isNaN(limit) || limit < 1) {
                limit = 1;
            } else if (limit > 5) {
                limit = 5;
            }
            storageLimitInput.value = limit;
            localStorage.setItem(STORAGE_LIMIT_KEY, limit);
            
            const currentSize = getLocalStorageSize();
            const newMaxBytes = limit * 1024 * 1024;
            
            if (currentSize > newMaxBytes) {
                showStatus(`警告: 現在の使用量が設定した上限を超えています。新しいデータを保存するには、古いデータを削除してください。`, true);
            } else {
                 showStatus(`ストレージ上限を ${limit}MB に設定しました。`, false);
            }
            updateStorageStatus();
        }

        function saveCsvToLocalStorage(filename, csvText) {
            const dataSize = (filename.length + csvText.length) * 2;
            if (!canStore(dataSize)) {
                showStatus('ストレージ容量が上限に達したため、保存できませんでした。古いデータを削除するか、上限を増やしてください。', true);
                return;
            }
            try {
                const key = `${STORAGE_PREFIX}${Date.now()}`;
                const data = { filename, csvText, savedAt: new Date().toISOString() };
                localStorage.setItem(key, JSON.stringify(data));
                loadSavedFiles();
            } catch (e) {
                console.error("LocalStorageへの保存に失敗しました: ", e);
                showStatus("データの保存に失敗しました。ブラウザのストレージ設定を確認してください。", true);
            }
        }

        function loadSavedFiles() {
            savedFilesList.innerHTML = '';
            const savedData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        savedData.push({ key, ...data });
                    } catch (e) { console.error(`Failed to parse saved data for key ${key}:`, e)}
                }
            }
            
            savedData.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

            if(savedData.length === 0) {
                savedFilesList.innerHTML = `<li class="text-sm text-gray-500">保存済みのデータはありません。</li>`;
            } else {
                savedData.forEach(({ key, filename, savedAt }) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
                    li.innerHTML = `
                        <div class="flex-grow overflow-hidden mr-2">
                            <strong class="text-sm truncate block">${filename}</strong>
                            <small class="text-xs text-gray-500">${new Date(savedAt).toLocaleString()}</small>
                        </div>
                        <div class="flex-shrink-0 space-x-2">
                            <button data-key="${key}" class="load-btn text-xs bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded">読込</button>
                            <button data-key="${key}" class="delete-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded">削除</button>
                        </div>
                    `;
                    savedFilesList.appendChild(li);
                });

                document.querySelectorAll('.load-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const key = e.target.dataset.key;
                    const data = JSON.parse(localStorage.getItem(key));
                    processAndRender(data.csvText);
                }));

                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const key = e.target.dataset.key;
                    if(confirm('このデータを削除しますか？')) {
                        localStorage.removeItem(key);
                        loadSavedFiles();
                    }
                }));
            }
            updateStorageStatus();
        }

        function getLocalStorageSize() {
            let total = 0;
            for (const key in localStorage) {
                if (!localStorage.hasOwnProperty(key)) continue;
                total += (localStorage.getItem(key).length + key.length) * 2;
            }
            return total;
        }

        function canStore(newDataSize) {
            const maxStorageBytes = (localStorage.getItem(STORAGE_LIMIT_KEY) || 1) * 1024 * 1024;
            return getLocalStorageSize() + newDataSize < maxStorageBytes;
        }
        
        function updateStorageStatus() {
            const maxStorageBytes = (localStorage.getItem(STORAGE_LIMIT_KEY) || 1) * 1024 * 1024;
            const currentSize = getLocalStorageSize();
            const percentage = maxStorageBytes > 0 ? ((currentSize / maxStorageBytes) * 100).toFixed(2) : 0;
            storageStatusDiv.textContent = `使用量: ${(currentSize / 1024).toFixed(1)} KB / ${(maxStorageBytes / 1024).toFixed(0)} KB (${percentage}%)`;
        }

        // --- Display Functions ---
        function displayBoards(records) {
            records.forEach(record => {
                const boardElement = createBoardElement(record.sfen, record.count);
                boardsContainer.appendChild(boardElement);
            });
        }
        
        function createBoardElement(sfen, count) {
            const [boardState, turn, hands] = sfen.split(' ');
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 flex flex-col items-center';

            // Gote Hand
            const goteHandDiv = document.createElement('div');
            goteHandDiv.className = 'hand-area w-full mb-1';
            const goteHand = parseHand(hands, 'gote');
            goteHandDiv.innerHTML = `<div class="text-xs">後手持: ${goteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? `<span class="text-xxs">${p.count}</span>` : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(goteHandDiv);
            
            // Board
            wrapper.appendChild(createBoardTable(boardState));

            // Sente Hand
            const senteHandDiv = document.createElement('div');
            senteHandDiv.className = 'hand-area w-full mt-1';
            const senteHand = parseHand(hands, 'sente');
            senteHandDiv.innerHTML = `<div class="text-xs">先手持: ${senteHand.map(p => `<span class="piece-in-hand">${p.kanji}${p.count > 1 ? `<span class="text-xxs">${p.count}</span>` : ''}</span>`).join('') || 'なし'}</div>`;
            wrapper.appendChild(senteHandDiv);

            // Info Area
            const infoDiv = document.createElement('div');
            infoDiv.className = 'w-full mt-3 space-y-2';
            
            let countHTML = (count !== null && !isNaN(count)) ? `<div class="text-center"><span class="text-xs text-gray-500 dark:text-gray-400">出現回数</span><p class="font-bold text-base text-indigo-600 dark:text-indigo-400">${count}</p></div>` : '';

            infoDiv.innerHTML = `<div class="flex justify-around items-baseline"><div class="text-center"><span class="text-xs text-gray-500 dark:text-gray-400">手番</span><p class="font-bold text-base">${turn === 'b' ? '▲ 先手' : '△ 後手'}</p></div>${countHTML}</div>`;

            // SFEN display with copy
            const sfenContainer = document.createElement('div');
            sfenContainer.className = 'relative flex items-center';
            const sfenInput = document.createElement('input');
            sfenInput.type = 'text';
            sfenInput.value = sfen;
            sfenInput.readOnly = true;
            sfenInput.className = 'sfen-input text-xs w-full text-gray-500 bg-gray-100 dark:bg-gray-700 p-2 pr-10 rounded-md border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500';
            const copyButton = document.createElement('button');
            copyButton.title = "SFENをコピー";
            copyButton.className = 'absolute right-0 top-0 h-full px-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white transition-colors';
            const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
            const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
            copyButton.innerHTML = copyIcon;
            copyButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sfenInput.select();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                copyButton.innerHTML = successIcon;
                setTimeout(() => { copyButton.innerHTML = copyIcon; }, 2000);
            });
            sfenContainer.appendChild(sfenInput);
            sfenContainer.appendChild(copyButton);
            infoDiv.appendChild(sfenContainer);
            wrapper.appendChild(infoDiv);
            return wrapper;
        }
        
        function createBoardTable(boardState) {
            const table = document.createElement('table');
            table.className = 'shogi-board mx-auto';
            const rows = boardState.split('/');
            for (let y = 0; y < 9; y++) {
                const tr = table.insertRow();
                let x = 0, isPromotedFlag = false;
                for (const char of rows[y]) {
                    if (char === '+') { isPromotedFlag = true; continue; }
                    if (!isNaN(parseInt(char))) {
                        for (let i = 0; i < parseInt(char); i++) { tr.insertCell(); x++; }
                    } else {
                        const td = tr.insertCell();
                        const isGote = char === char.toLowerCase();
                        const pieceKey = (isPromotedFlag ? '+' : '') + char.toUpperCase();
                        td.textContent = sfenToKanjiMap[pieceKey] || '?';
                        if (isGote) td.classList.add('gote');
                        if (isPromotedFlag) td.classList.add('promoted');
                        isPromotedFlag = false; x++;
                    }
                }
            }
            return table;
        }

        function parseHand(handsStr, player) {
            if (!handsStr || handsStr === '-') return [];
            const hand = []; let count = 1;
            for (const char of handsStr) {
                if (!isNaN(parseInt(char))) { count = parseInt(char); }
                else {
                    const isSente = char === char.toUpperCase();
                    if ((player === 'sente' && isSente) || (player === 'gote' && !isSente)) {
                       hand.push({ kanji: sfenToKanjiMap[char.toUpperCase()] || '?', count: count });
                    }
                    count = 1;
                }
            }
            return hand;
        }
        
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusDisplay.classList.remove('hidden');
            statusDisplay.classList.toggle('bg-red-100', isError); statusDisplay.classList.toggle('dark:bg-red-900', isError);
            statusDisplay.classList.toggle('border-red-400', isError); statusDisplay.classList.toggle('dark:border-red-700', isError);
            statusDisplay.classList.toggle('text-red-700', isError); statusDisplay.classList.toggle('dark:text-red-200', isError);
            statusDisplay.classList.toggle('bg-blue-100', !isError); statusDisplay.classList.toggle('dark:bg-blue-900/50', !isError);
            statusDisplay.classList.toggle('border-blue-400', !isError); statusDisplay.classList.toggle('dark:border-blue-700', !isError);
            statusDisplay.classList.toggle('text-blue-700', !isError); statusDisplay.classList.toggle('dark:text-blue-200', !isError);
        }
    </script>
</body>
</html>
